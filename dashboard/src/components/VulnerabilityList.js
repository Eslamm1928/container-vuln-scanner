import React, { useState, useEffect } from 'react';
import './VulnerabilityList.css';
// import { getVulnerabilities } from '../services/api'; // Ù…Ø´ Ù…Ø­ØªØ§Ø¬ÙŠÙ†Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙŠØ¬ÙŠ props

function VulnerabilityList({ scanId, vulnerabilities, onClose }) {
  const [groupedVulns, setGroupedVulns] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (vulnerabilities) {
      groupVulnerabilities();
      setLoading(false);
    }
  }, [vulnerabilities]);

  const groupVulnerabilities = () => {
    const grouped = vulnerabilities.reduce((acc, vuln) => {
      const severity = vuln.severity || 'UNKNOWN';
      if (!acc[severity]) {
        acc[severity] = [];
      }
      acc[severity].push(vuln);
      return acc;
    }, {});

    setGroupedVulns(grouped);
  };

  const getSeverityColor = (severity) => {
    const colors = {
      CRITICAL: '#d32f2f', // Ø£Ø­Ù…Ø± ØºØ§Ù…Ù‚
      HIGH: '#f57c00',     // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
      MEDIUM: '#fbc02d',   // Ø£ØµÙØ±
      LOW: '#388e3c',      // Ø£Ø®Ø¶Ø±
      UNKNOWN: '#9e9e9e'   // Ø±Ù…Ø§Ø¯ÙŠ
    };
    return colors[severity] || colors.UNKNOWN;
  };

  const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNKNOWN'];

  const totalCount = vulnerabilities.length;
  const severityCounts = Object.keys(groupedVulns).reduce((acc, severity) => {
    acc[severity] = groupedVulns[severity].length;
    return acc;
  }, {});

  return (
    <div className="vulnerability-list">
      <div className="vuln-header">
        <h3>Vulnerabilities - Scan #{scanId}</h3>
        <button className="close-btn" onClick={onClose}>Ã—</button>
      </div>

      {loading ? (
        <div className="loading">Loading vulnerabilities...</div>
      ) : totalCount === 0 ? (
        <div className="no-vulns">
          <span style={{ fontSize: '2rem' }}>âœ…</span>
          <p>No vulnerabilities found!</p>
          <p className="subtext">This image appears to be secure.</p>
        </div>
      ) : (
        <>
          {/* Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† */}
          <div className="vuln-summary">
            <div className="summary-item">
              <span className="summary-label">Total:</span>
              <span className="summary-value"><strong>{totalCount}</strong></span>
            </div>
            {severityOrder.map(severity => {
              if (severityCounts[severity]) {
                return (
                  <div key={severity} className="summary-item">
                    <span className="summary-label" style={{ color: getSeverityColor(severity), fontWeight: 'bold' }}>
                      {severity}:
                    </span>
                    <span className="summary-value">{severityCounts[severity]}</span>
                  </div>
                );
              }
              return null;
            })}
          </div>

          {/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© */}
          <div className="vuln-groups">
            {severityOrder.map(severity => {
              if (groupedVulns[severity]) {
                return (
                  <div key={severity} className="vuln-group">
                    <h4 
                      className="severity-header"
                      style={{ 
                        borderLeft: `5px solid ${getSeverityColor(severity)}`,
                        paddingLeft: '10px',
                        margin: '15px 0 10px 0'
                      }}
                    >
                      {severity} ({groupedVulns[severity].length})
                    </h4>
                    
                    <div className="vuln-items">
                      {groupedVulns[severity].map((vuln, index) => (
                        <div key={index} className="vuln-item" style={{ marginBottom: '10px', padding: '10px', background: '#f5f5f5', borderRadius: '5px' }}>
                          
                          <div className="vuln-package">
                            {/* Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù‡Ù… Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… package_name */}
                            <strong>ğŸ“¦ Package:</strong> {vuln.package_name || 'Unknown'}
                          </div>
                          
                          <div className="vuln-version">
                            {/* Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù‡Ù… Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… fixed_version */}
                            <strong>ğŸ”§ Fixed In:</strong> {vuln.fixed_version || 'Not Fixed / N/A'}
                          </div>

                          {/* Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØµÙ Ù„Ø£Ù†Ù‡ Ù…ÙÙŠØ¯ Ø¬Ø¯Ø§Ù‹ */}
                          <div className="vuln-desc" style={{ fontSize: '0.85rem', color: '#666', marginTop: '5px' }}>
                            {vuln.description}
                          </div>

                        </div>
                      ))}
                    </div>
                  </div>
                );
              }
              return null;
            })}
          </div>
        </>
      )}
    </div>
  );
}

export default VulnerabilityList;
