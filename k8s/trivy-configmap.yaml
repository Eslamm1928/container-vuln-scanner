apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-db-updater
  namespace: default
data:
  process-results.py: |
    import os
    import json
    import psycopg2
    import sys

    SCAN_ID = os.getenv('SCAN_ID')
    IMAGE_NAME = os.getenv('IMAGE_NAME')
    DB_HOST = os.getenv('DB_HOST', 'postgres')
    DB_NAME = os.getenv('DB_NAME', 'vuln_scanner')
    DB_USER = os.getenv('DB_USER', 'postgres')
    DB_PASSWORD = os.getenv('DB_PASSWORD')
    DB_PORT = os.getenv('DB_PORT', '5432')

    try:
        # Read Trivy results
        with open('/tmp/results.json', 'r') as f:
            results = json.load(f)

        # Connect to database
        conn = psycopg2.connect(
            host=DB_HOST,
            database=DB_NAME,
            user=DB_USER,
            password=DB_PASSWORD,
            port=DB_PORT
        )
        cur = conn.cursor()

        # Update scan status to RUNNING
        cur.execute("UPDATE scans SET status='RUNNING' WHERE id=%s", (SCAN_ID,))
        conn.commit()

        # Process vulnerabilities
        vuln_count = 0
        for result in results.get('Results', []):
            for vuln in result.get('Vulnerabilities', []):
                cur.execute("""
                    INSERT INTO vulnerabilities
                    (scan_id, vulnerability_id, severity, pkg_name, installed_version)
                    VALUES (%s, %s, %s, %s, %s)
                    ON CONFLICT DO NOTHING
                """, (
                    SCAN_ID,
                    vuln.get('VulnerabilityID'),
                    vuln.get('Severity'),
                    vuln.get('PkgName'),
                    vuln.get('InstalledVersion')
                ))
                vuln_count += 1

        # Update scan status to DONE
        cur.execute("UPDATE scans SET status='DONE', completed_at=NOW() WHERE id=%s", (SCAN_ID,))
        conn.commit()

        cur.close()
        conn.close()

        print(f"Scan {SCAN_ID} completed. Found {vuln_count} vulnerabilities.")
        sys.exit(0)

    except Exception as e:
        print(f"Error processing scan {SCAN_ID}: {e}")
        try:
            conn = psycopg2.connect(
                host=DB_HOST,
                database=DB_NAME,
                user=DB_USER,
                password=DB_PASSWORD,
                port=DB_PORT
            )
            cur = conn.cursor()
            cur.execute("UPDATE scans SET status='FAILED' WHERE id=%s", (SCAN_ID,))
            conn.commit()
            cur.close()
            conn.close()
        except:
            pass
        sys.exit(1)


